<!DOCTYPE html>
<html lang=”en”>
<head>    
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <script type="module" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script type="module" src="../dist/space-driver.js"></script>
    <style>
        body {
            margin: 0px;
            height: 100vh;
        }
        canvas {
            display: block;
        }
        #inputViz {
            width: 400px;
            height: 400px;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot@1.6.25/dist/uPlot.min.css" integrity="sha256-32MMao1vjur/JktQ9zzlsRT2Rv/ZoLt08EmwoAE1+gQ=" crossorigin="anonymous">
</head>
<body>
    <p id="errorMessage">WebHID is not available. Are you using Chrome or Edge? Are you running from <tt>localhost</tt> or HTTPS?</p>
    <button id="hidButton" style="display: none;">Request HID Device</button>
    <button id="downloadButton">DownloadCSV</button>
    <p class="text">Connection status: <span class="text" id="status"></span></p>

    <div id="plot"></div>
    <div id="inputViz"></div>
</body>
<script type="module">
    import { ThreeDMouse } from '../dist/ThreeDMouse.js';
    import * as THREE from "https://unpkg.com/three@0.126.1/build/three.module.js"
    import { BufferGeometryUtils } from "https://unpkg.com/three@0.126.1/examples/jsm/utils/BufferGeometryUtils.js";
    import {TwistViz} from '../dist/TwistViz.js';
    import DataManager from '../dist/dataManager.js';
    import * as Robot from "./main_robot.js";
    import uPlot from 'https://cdn.jsdelivr.net/npm/uplot@1.6.25/+esm'
    

    let twistViz = null;

    window.addEventListener('DOMContentLoaded', (event) => {
        if (navigator.hid) {
            document.getElementById("errorMessage").innerText = "";
            document.getElementById("hidButton").style.display = "block";
        } else {
            return
        }
        
        const connectButton = document.getElementById('hidButton')
        connectButton.addEventListener('click', () => 
        ThreeDMouse.requestDevice().then(device => {
            twistViz = new TwistViz(document.getElementById("inputViz"));
            twistViz.begin()
            window.addEventListener("3dmouseinput", event => {
                let values = event.detail.controlValue
                // Process the input data and update the marker
                twistViz.setTwist([values.Tx_f, values.Ty_f, values.Tz_f, values.Rx_f, values.Ry_f, values.Rz_f]);

                // Move the robot based on the input data
                Robot.move_robot(event.detail.controlValue);

                Robot.gripper(event.detail.buttonValue);

            });

                connectButton.disabled = true;
            }).catch(error => {
                document.getElementById("errorMessage").innerText = error;
            })
        );
        document.getElementById('downloadButton').addEventListener('click', downloadAccumulatedData);
    });

    function arrayToCSV(data) {
            return data.map(row => row.join(',')).join('\n');
        }
    function downloadCSV(csvContent, fileName = "data.csv") {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
        

    function downloadAccumulatedData() {
        const csvContent = arrayToCSV(DataManager.getData());
        downloadCSV(csvContent, "output.csv");
    }


    function makePlot(container, data) {
        let fmtVal = (u, raw, sidx, didx) => {
				if (didx == null) {
					let d = u.data[sidx];
					return `${d[d.length - 1].toFixed(2)} (last)`;
				}

				return raw == null ? '' : raw;
			};
        const opts = {
            title: "",
            width: 800,
            height: 200,
            cursor: {
						drag: {
							setScale: false,
						}
					},
					select: {
						show: false,
					},
            scales: {
                "x": {
                    time: false
                },
                "%": {
                    auto: false,
                    range: [-1, 1],
                }
            },
            series: [
                {},
                {
                    label: "X",
                    scale: "%",
                    stroke: "red",
                    value: fmtVal
                },
                {
                    label: "Y",
                    scale: "%",
                    stroke: "green",
                    value: fmtVal
                },
                {
                    label: "Z",
                    scale: "%",
                    stroke: "blue",
                    value: fmtVal
                },
                {
                    label: "R",
                    scale: "%",
                    stroke: "cyan",
                    value: fmtVal
                },
                {
                    label: "P",
                    scale: "%",
                    stroke: "yellow",
                    value: fmtVal
                },
                {
                    label: "Y",
                    scale: "%",
                    stroke: "magenta",
                    value: fmtVal
                },
            ],
            axes: [
                {},
                {
                    scale: '%',
                    values: (u, vals, space) => vals.map(v => +v.toFixed(1)),
                }
            ]
        };

        return new uPlot(opts, data, container);
    }

    let data = [[...Array(600).keys()]]
    for (let i = 1; i < 7; i++) {
        data.push(new Array(600).fill(0))
    }
    let i = 600;
    let plot = makePlot(document.getElementById("plot"), data);
    window.addEventListener("3dmouseinput", event => {
        data.forEach((d, i) => {
            d.shift()
        })
        data[0].push(i)
        data[1].push(event.detail.controlValue.Tx_f)
        data[2].push(event.detail.controlValue.Ty_f)
        data[3].push(event.detail.controlValue.Tz_f)
        data[4].push(event.detail.controlValue.Rx_f)
        data[5].push(event.detail.controlValue.Ry_f)
        data[6].push(event.detail.controlValue.Rz_f)
        plot.setData(data)
        i+= 1
    })


</script>
</html>

