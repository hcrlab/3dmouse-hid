<!DOCTYPE html>
<html lang=”en”>
<head>    
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <!-- See threejs usage documentation: https://threejs.org/docs/#manual/en/introduction/Installation -->
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/",
            "uplot": "https://cdn.jsdelivr.net/npm/uplot@1.6.25/+esm"
          }
        }
    </script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <style>
        body {
            margin: 0px;
            height: 100vh;
        }
        canvas {
            display: block;
        }
        #inputViz {
            width: 400px;
            height: 400px;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot@1.6.25/dist/uPlot.min.css" integrity="sha256-32MMao1vjur/JktQ9zzlsRT2Rv/ZoLt08EmwoAE1+gQ=" crossorigin="anonymous">
</head>
<body>
    <p id="errorMessage">WebHID is not available. Are you using Chrome or Edge? Are you running from <tt>localhost</tt> or HTTPS?</p>
    <button id="hidButton" style="display: none;">Request HID Device</button>
    <button id="downloadButton">DownloadCSV</button>
    <p class="text">Connection status: <span class="text" id="status"></span></p>

    <button id="rotateButton">Rotate</button>
    <button id="translateButton">Translate</button>
    <button id="Both(T+R)">Both(T+R)</button>
    <div id="plot"></div>
    <div id="inputViz"></div>

    <div>
        <div>
            <canvas id="view0" alt="Camera 0 Feed" ></canvas>
        </div>

        <div>
            <canvas id="view1" alt="Camera 1 Feed" >
        </div>

        <div>
            <canvas id="view2" alt="Camera 2 Feed" >
        </div>
    </div>

    
</body>
<script type="module">
    import { ThreeDMouse, SmoothingDeadbandFilter } from '../dist/ThreeDMouse.js';
    import { rotateTwist } from '../dist/linAlg.js';
    import { TwistViz} from '../dist/TwistViz.js';
    import { Robot, subscribeToCameraTopic } from "./main_robot.js";
    import uPlot from 'uplot'


    let twistViz = null;
    let currentMapping = 0
    let cameraMappings = [
        new THREE.Matrix3(
            0, -1, 0,
            1, 0, 0,
            0, 0, 1
        ),
        new THREE.Matrix3(
            1, 0, 0,
            0, 1, 0,
            0, 0, 1
        ),
        new THREE.Matrix3(
            1, 0, 0,
            0, 1, 0,
            0, 0, 1
        )]


    window.addEventListener('DOMContentLoaded', (event) => {
        let ros = initializeRos()
        let robot = new Robot(ros)
        if (navigator.hid) {
            document.getElementById("errorMessage").innerText = "";
            document.getElementById("hidButton").style.display = "block";
        } else {
            return
        }

        const connectButton = document.getElementById('hidButton')
        connectButton.addEventListener('click', () => 
        ThreeDMouse.requestDevice().then(device => {
            if (!device) {
                return
            }
            device.configureFilter(new SmoothingDeadbandFilter({smoothing: 0.5, deadband: 0.1}));
            twistViz = new TwistViz(document.getElementById("inputViz"));
            twistViz.begin()
            window.addEventListener("3dmouseinput", event => {
                let values = event.detail.filteredInput
                let rotated = rotateTwist(values, cameraMappings[currentMapping])
                twistViz.setTwist(values);
                robot.move(rotated);
            });

                connectButton.disabled = true;
            }).catch(error => {
                document.getElementById("errorMessage").innerText = error;
            })
        );
        document.getElementById('downloadButton').addEventListener('click', downloadAccumulatedData);
        subscribeToCameraTopic(ros, '/camera0/image_raw', document.getElementById('view0'));
        subscribeToCameraTopic(ros, '/camera1/image_raw', document.getElementById('view1'));
        subscribeToCameraTopic(ros, '/camera2/image_raw', document.getElementById('view2'));

    });

    function arrayToCSV(data) {
            return data.map(row => row.join(',')).join('\n');
        }
    function downloadCSV(csvContent, fileName = "data.csv") {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    function downloadAccumulatedData() {
        const csvContent = arrayToCSV(DataManager.getData());
        downloadCSV(csvContent, "output.csv");
    }


    function makePlot(container, data) {
        let fmtVal = (u, raw, sidx, didx) => {
				if (didx == null) {
					let d = u.data[sidx];
					return `${d[d.length - 1].toFixed(2)}`;
				}

				return raw == null ? '' : raw;
			};
        const opts = {
            title: "",
            width: 800,
            height: 200,
            cursor: {
						drag: {
							setScale: false,
						}
					},
					select: {
						show: false,
					},
            scales: {
                "x": {
                    time: false
                },
                "%": {
                    auto: false,
                    range: [-1, 1],
                }
            },
            series: [
                {},
                {
                    label: "X",
                    scale: "%",
                    stroke: "red",
                    value: fmtVal
                },
                {
                    label: "Y",
                    scale: "%",
                    stroke: "green",
                    value: fmtVal
                },
                {
                    label: "Z",
                    scale: "%",
                    stroke: "blue",
                    value: fmtVal
                },
                {
                    label: "R",
                    scale: "%",
                    stroke: "cyan",
                    value: fmtVal
                },
                {
                    label: "P",
                    scale: "%",
                    stroke: "yellow",
                    value: fmtVal
                },
                {
                    label: "Y",
                    scale: "%",
                    stroke: "magenta",
                    value: fmtVal
                },
            ],
            axes: [
                {},
                {
                    scale: '%',
                    values: (u, vals, space) => vals.map(v => +v.toFixed(1)),
                }
            ]
        };

        return new uPlot(opts, data, container);
    }

    let data = [[...Array(600).keys()]]
    for (let i = 1; i < 7; i++) {
        data.push(new Array(600).fill(0))
    }
    let i = 600;
    let plot = makePlot(document.getElementById("plot"), data);
    window.addEventListener("3dmouseinput", event => {
        data.forEach((d, i) => {
            d.shift()
        })
        const [linear, angular] = event.detail.filteredInput
        data[0].push(i)
        data[1].push(linear[0])
        data[2].push(linear[1])
        data[3].push(linear[2])
        data[4].push(angular[0])
        data[5].push(angular[1])
        data[6].push(angular[2])
        plot.setData(data)
        i+= 1
    })

    let activeButton = null;

    function activateButton(clickedButton, actionType) {
        const enlargedWidth = '800px';
        const enlargedHeight = '450px';
        const reducedWidth = '600px';
        const reducedHeight = '400px';

        // Reset all images to their reduced size
        let images = document.querySelectorAll('img');
        for (let img of images) {
            img.style.width = reducedWidth;
            img.style.height = reducedHeight;
            img.style.margin = '0';  // Reset the margins
        }

        // Reset the previous active button (if any)
        if (activeButton) {
            activeButton.style.backgroundColor = '';
        }

        // Execute the functionality based on the action type
        switch (actionType) {
            case 'action0':
                window.actionType='action0'
                window.globalInputData =window.movefront
                adjustImageSize('displayedImageCamera0', enlargedWidth, enlargedHeight);
                break;
            case 'action1':
                window.actionType='action1'
                window.globalInputData =window.movetop
                adjustImageSize('displayedImageCamera1', enlargedWidth, enlargedHeight);
                break;
            case 'action2':
                window.actionType='action2'
                window.globalInputData =window.moveside
                adjustImageSize('displayedImageCamera2', enlargedWidth, enlargedHeight);
                break;
            default:
                alert('Unknown action!');
        }

        // Activate the clicked button
        clickedButton.style.backgroundColor = 'red';

        // Update the active button reference
        activeButton = clickedButton;

    }
    window.activateButton = activateButton;

    function adjustImageSize(imageId, width, height) {
        let img = document.getElementById(imageId);
        let widthDifference = parseInt(width) - img.clientWidth;
        let heightDifference = parseInt(height) - img.clientHeight;

        img.style.width = width;
        img.style.height = height;
        img.style.margin = `-${heightDifference / 2}px -${widthDifference / 2}px`;  // Adjust margins
    }

    function initializeRos(){
    let ros = new ROSLIB.Ros({
        url: 'ws://127.0.0.1:9090'
      });
  
      ros.on('connection', () => {
        document.getElementById('status').innerHTML = 'Connected';
      });
  
      ros.on('error', (error) => {
        document.getElementById('status').innerHTML = 'Error';
      });
  
      ros.on('close', () => {
        document.getElementById('status').innerHTML = 'Closed';
      });
    return ros
}

</script>
</html>

