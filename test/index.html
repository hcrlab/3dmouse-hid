<!DOCTYPE html>
<html lang=”en”>
<head>    
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <!-- See threejs usage documentation: https://threejs.org/docs/#manual/en/introduction/Installation -->
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/",
            "uplot": "https://cdn.jsdelivr.net/npm/uplot@1.6.25/+esm",
            "tweakpane": "https://cdn.jsdelivr.net/npm/tweakpane@4.0.1/dist/tweakpane.min.js"
          }
        }
    </script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <style>
        body {
        }
        canvas {
            display: block;
        }
        #inputViz {
            width: 400px;
            height: 400px;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot@1.6.25/dist/uPlot.min.css" integrity="sha256-32MMao1vjur/JktQ9zzlsRT2Rv/ZoLt08EmwoAE1+gQ=" crossorigin="anonymous">
</head>
<body>


    <div>
        <div id="configuration"></div>
        <div id="plot"></div>
        <div id="inputViz"></div>
        <div>
            <canvas id="view0"></canvas>
        </div>

        <div>
            <canvas id="view1"></canvas>
        </div>

        <div>
            <canvas id="view2"></canvas>
        </div>
    </div>

    
</body>
<script type="module">
    import { ThreeDMouse, SmoothingDeadbandFilter } from '../dist/ThreeDMouse.js';
    import { rotateTwist } from '../dist/linAlg.js';
    import { TwistViz} from '../dist/TwistViz.js';
    import { Robot, subscribeToCameraTopic } from "./main_robot.js";
    import uPlot from 'uplot'
    import {Pane} from 'tweakpane';
    import * as THREE from 'three'

    let threeDMouse = null
    let filter = new SmoothingDeadbandFilter({smoothing: 0.5, deadband: 0.1})
    let twistViz = null;
    let pane = null
    const configurationParams = {
        message: "",
        rosStatus: false,
        smoothing: .9,
        softmaxWeight: 50,
        deadbandWeight: .4,
        translationEnabled: true,
        rotationEnabled: true,
        deadbandSize: .01,
    };
    let currentMapping = 1
    let connectButton
    let cameraMappings = [
        [new THREE.Matrix3(
            0, -1, 0,
            1, 0, 0,
            0, 0, 1
            ),
            'base_link',
            new THREE.Matrix4(
                1, 0, 0, 0,
                0, 1, 0, -5,
                0, 0, 1, 2,
                0, 0, 0, 1),
        ],
        [new THREE.Matrix3(
            0, 1, 0,
            -1, 0, 0,
            0, 0, 1
        ),
            'base_link',
            new THREE.Matrix4(
                1, 0, 0, 0,
                0, 1, 0, -.0001,
                0, 0, 1, 5,
                0, 0, 0, 1),
        ],
        new THREE.Matrix3(
            1, 0, 0,
            0, 1, 0,
            0, 0, 1
        )]



    window.addEventListener('DOMContentLoaded', (event) => {
        pane = new Pane({container: document.getElementById("configuration")});
        connectButton = pane.addButton({title: "Connect 3D Mouse", disabled: true})
        pane.addBinding(configurationParams, 'message', {readonly: true, multiline: true, bufferSize: 5})
        pane.addBinding(configurationParams, 'rosStatus', {readOnly: true})
        const f = pane.addFolder({
            title: 'Filtering',
            disabled: true
        });
        f.addBinding(configurationParams, "translationEnabled").on("change", e => {
            filter.translationMultiplier = e.value ? 1. : 0.;
        })
        f.addBinding(configurationParams, "rotationEnabled").on("change", e => {
            filter.rotationMultiplier = e.value ? 1. : 0.;
        })
        f.addBinding(
            configurationParams, 'softmaxWeight',
            {min: 0.01, max: 100}
        ).on("change", e => {
            filter.softmaxWeight = e.value
        })
        f.addBinding(
            configurationParams, 'deadbandSize',
            {min: 0., max:1.0}
        ).on("change", e => {
            filter.deadband = e.value
        })
        f.addBinding(
            configurationParams, 'deadbandWeight',
            {min: 0, max:10}
        ).on("change", e => {
            filter.cubicDeadbandWeight = e.value
        })


        let ros = initializeRos()
        let robot = new Robot(ros)
        if (navigator.hid) {
            configurationParams["message"] = "";
            connectButton.disabled = false
        } else {
            return
        }

        connectButton.on('click', () =>
            ThreeDMouse.requestDevice(
                {emitRepeatedEvents: true,
                 filter: filter}
            ).then(device => {
                if (!device) {
                    return
                }
                twistViz = new TwistViz(document.getElementById("inputViz"));
                twistViz.begin()
                window.addEventListener("3dmouseinput", event => {
                    let values = event.detail.filteredInput
                    let [frameRotation, controlFrame, cameraPose] = cameraMappings[currentMapping]
                    let rotated = rotateTwist(values, frameRotation)
                    twistViz.configureForView(null, cameraPose)
                    twistViz.setTwist(values, controlFrame);
                    robot.move(rotated);
                });

                threeDMouse = device
                connectButton.disabled = true
                f.disabled = false
            }).catch(error => {
                configurationParams["message"] = error
                pane.refresh()
            })
        );
        subscribeToCameraTopic(ros, '/camera0/image_raw', document.getElementById('view0'));
        subscribeToCameraTopic(ros, '/camera1/image_raw', document.getElementById('view1'));
        subscribeToCameraTopic(ros, '/camera2/image_raw', document.getElementById('view2'));

    });

    function makePlot(container, data) {
        let fmtVal = (u, raw, sidx, didx) => {
				if (didx == null) {
					let d = u.data[sidx];
					return `${d[d.length - 1].toFixed(2)}`;
				}

				return raw == null ? '' : raw;
			};
        const opts = {
            title: "",
            width: 800,
            height: 200,
            cursor: {
						drag: {
							setScale: false,
						}
					},
					select: {
						show: false,
					},
            scales: {
                "x": {
                    time: false
                },
                "%": {
                    auto: false,
                    range: [-1, 1],
                }
            },
            series: [
                {},
                {
                    label: "X",
                    scale: "%",
                    stroke: "red",
                    value: fmtVal
                },
                {
                    label: "Y",
                    scale: "%",
                    stroke: "green",
                    value: fmtVal
                },
                {
                    label: "Z",
                    scale: "%",
                    stroke: "blue",
                    value: fmtVal
                },
                {
                    label: "R",
                    scale: "%",
                    stroke: "cyan",
                    value: fmtVal
                },
                {
                    label: "P",
                    scale: "%",
                    stroke: "yellow",
                    value: fmtVal
                },
                {
                    label: "Y",
                    scale: "%",
                    stroke: "magenta",
                    value: fmtVal
                },
            ],
            axes: [
                { show: false},
                {
                    scale: '%',
                    values: (u, vals, space) => vals.map(v => +v.toFixed(1)),
                }
            ]
        };

        return new uPlot(opts, data, container);
    }

    let data = [[...Array(600).keys()]]
    for (let i = 1; i < 7; i++) {
        data.push(new Array(600).fill(0))
    }
    let i = 600;
    let plot = makePlot(document.getElementById("plot"), data);
    window.addEventListener("3dmouseinput", event => {
        data.forEach((d, i) => {
            d.shift()
        })
        const [linear, angular] = event.detail.filteredInput
        data[0].push(i)
        data[1].push(linear[0])
        data[2].push(linear[1])
        data[3].push(linear[2])
        data[4].push(angular[0])
        data[5].push(angular[1])
        data[6].push(angular[2])
        plot.setData(data)
        i+= 1
    })

    function initializeRos(){
        let ros = new ROSLIB.Ros({
            url: 'ws://127.0.0.1:9090'
          });

          ros.on('connection', () => {
            configurationParams.rosStatus = true
          });

          ros.on('error', (error) => {
            configurationParams.message = "ROS connection failed";
          });

          ros.on('close', () => {
            configurationParams.rosStatus = false
          });
        return ros
    }

</script>
</html>

