<!DOCTYPE html>
<html lang=”en”>
<head>    
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <!-- See threejs usage documentation: https://threejs.org/docs/#manual/en/introduction/Installation -->
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/",
            "tweakpane": "https://cdn.jsdelivr.net/npm/tweakpane@4.0.1/dist/tweakpane.min.js"
          }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/js/bootstrap.bundle.min.js" integrity="sha512-ToL6UYWePxjhDQKNioSi4AyJ5KkRxY+F1+Fi7Jgh0Hp5Kk2/s8FD7zusJDdonfe5B00Qw+B8taXxF6CFLnqNCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css" integrity="sha512-Z/def5z5u2aR89OuzYcxmDJ0Bnd5V1cKqBEbvLOiUNWdg9PQeXVvXLI90SE4QOHGlfLqUnDNVAYyZi8UwUTmWQ==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        body {
            background-color: #111;
            margin: 1rem;
        }
        #interface {
            display: inline-flex;
            gap: .5rem
        }
        canvas {
            display: block;
        }
        #camera-views,
        .view-container {
            position: relative;
            display: inline-block;
        }
        .view-container .overlay {
            position: absolute;
            width: 200px;
            height: 200px;
            top: 0;
            left: 0
        }
        .view-container.inactive {
            --size-percentage: 25%;
            position: absolute;
            left: calc((100% - var(--size-percentage)) / 2);
            bottom: calc((100% - var(--size-percentage)) / 2);
            transform: scale(var(--size-percentage));
            border: 1px solid black;
        }
        #control-pane {

        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uplot@1.6.25/dist/uPlot.min.css" integrity="sha256-32MMao1vjur/JktQ9zzlsRT2Rv/ZoLt08EmwoAE1+gQ=" crossorigin="anonymous">
</head>
<body>
    <section id="interface">
        <div id="control-pane">
            <div id="configuration"></div>
            <div id="plot"></div>
        </div>
        <div id="camera-views">
            <div class="view-container" id="view0">
                <canvas class="overlay"></canvas>
                <canvas class="view"></canvas>
            </div>

            <div class="view-container inactive" id="view1">
                <canvas class="overlay"></canvas>
                <canvas class="view"></canvas>
            </div>
        </div>
    </section>

    
</body>
<script type="module">
    import { ThreeDMouse, SmoothingDeadbandFilter } from '../dist/ThreeDMouse.js';
    import { rotateTwist } from '../dist/linAlg.js';
    import { TwistViz} from '../dist/TwistViz.js';
    import { Robot, subscribeToCameraTopic } from "./main_robot.js";
    import {Pane} from 'tweakpane';
    import * as THREE from 'three'

    let ros = null
    let robot = null
    let threeDMouse = null
    let filter = new SmoothingDeadbandFilter({smoothing: 0.5, deadband: 0.1})
    let twistVizOverlays = null;
    let pane = null

    const status = {
        message: "",
        rosStatus: false,
    }
    const configurationParams = {
        smoothing: .9,
        softmaxWeight: 50,
        deadbandWeight: .4,
        translationEnabled: true,
        rotationEnabled: true,
        deadbandSize: .01,
    };
    const lastValue = {
        x: 0,
        y: 0,
        z: 0,
        r: 0,
        p: 0,
        ya: 0,
        buttonsValue: 0,
        t: 0,
        xyz: {x: 0, y: 0, z: 0},
        rpy: {x: 0, y: 0, z: 0}
    }
    let currentMapping = 0
    let cameraMappings = [
        {
            topic: '/camera0/image_raw',
            axes: new THREE.Matrix3(
                0, -1, 0,
                1, 0, 0,
                0, 0, 1
            ),
            control_frame: 'base_link',
            camera_pose: new THREE.Matrix4(
                1, 0, 0, 0,
                0, 1, 0, -5,
                0, 0, 1, 2,
                0, 0, 0, 1),
        },
        {
            topic: '/camera1/image_raw',
            axes: new THREE.Matrix3(
                0, 1, 0,
                -1, 0, 0,
                0, 0, 1
            ),
            control_frame: 'base_link',
            camera_pose: new THREE.Matrix4(
                1, 0, 0, 0,
                0, 1, 0, -.0001,
                0, 0, 1, 5,
                0, 0, 0, 1)
        }
    ]

    window.addEventListener('DOMContentLoaded', (event) => {
        pane = new Pane({container: document.getElementById("configuration")});
        let connectButton = pane.addButton({title: "Connect 3D Mouse", disabled: true})
        pane.addBinding(status, 'message', {readonly: true, multiline: true, bufferSize: 5})
        pane.addBinding(status, 'rosStatus', {readonly: true})
        const f = pane.addFolder({
            title: 'Filtering',
            disabled: true
        });
        f.addBinding(configurationParams, "translationEnabled").on("change", e => {
            filter.translationMultiplier = e.value ? 1. : 0.;
        })
        f.addBinding(configurationParams, "rotationEnabled").on("change", e => {
            filter.rotationMultiplier = e.value ? 1. : 0.;
        })
        f.addBinding(
            configurationParams, 'softmaxWeight',
            {min: 0.01, max: 100}
        ).on("change", e => {
            filter.softmaxWeight = e.value
        })
        f.addBinding(
            configurationParams, 'deadbandSize',
            {min: 0., max:1.0}
        ).on("change", e => {
            filter.deadband = e.value
        })
        f.addBinding(
            configurationParams, 'deadbandWeight',
            {min: 0, max:10}
        ).on("change", e => {
            filter.cubicDeadbandWeight = e.value
        })
        const g = pane.addFolder({
            title: 'Graphs',
            disabled: true,
            expanded: false
        });
        const GRAPH_OPTIONS = {
            readonly: true,
            view: 'graph',
            min: -1,
            max: +1,
            interval: 10,
        }
        for (let key of ["x", "y", "z", "r", "p", "ya"]) {
            g.addBinding(lastValue, key, GRAPH_OPTIONS)
        }
        const v = pane.addFolder({
            title: 'Values',
            disabled: true
        });
        v.addBinding(lastValue, "xyz", {readonly: false})
        v.addBinding(lastValue, "rpy", {readonly: false})
        v.addBinding(lastValue, 'buttonsValue', {readonly: true})
        v.addBinding(lastValue, 't', {readonly: true})

        // Check if WebHID is available before going further.
        if (navigator.hid) {
            configurationParams["message"] = "";
            connectButton.disabled = false
        } else {
            return
        }

        connectButton.on('click', () =>
            ThreeDMouse.requestDevice(
                {emitRepeatedEvents: true,
                 filter: filter}
            ).then(device => {
                if (!device) {
                    return
                }
                initializeRos().then(rosConnection => {
                    ros = rosConnection
                    robot = new Robot(ros)
                    twistVizOverlays = []
                    for (let i = 0; i < cameraMappings.length; i += 1) {
                        let {topic: topic, axes: axes, control_frame: controlFrame, camera_pose: cameraPose} = cameraMappings[i]
                        let viewContainer = document.querySelector(`#view${i}`)
                        const newOverlay = configureVideoView(viewContainer, ros, topic, null, cameraPose)
                        newOverlay.begin()
                        twistVizOverlays.push(newOverlay)
                    }
                }).catch(error => {
                    configurationParams["message"] = "ROS connection error"
                })

                window.addEventListener("3dmouseinput", event => {
                    let values = event.detail.filteredInput
                    if (twistVizOverlays) {
                        let {axes: axes} = cameraMappings[currentMapping]
                        for (let i = 0; i < cameraMappings.length; i += 1) {
                            let rotated = rotateTwist(values, axes)
                            twistVizOverlays[i].setTwist(values);
                            if (currentMapping === i) {
                                robot.move(rotated);
                            }
                        }
                    }
                    lastValue["x"] = values[0][0]
                    lastValue["y"] = values[0][1]
                    lastValue["z"] = values[0][2]
                    lastValue["xyz"] = {x: lastValue["x"], y: lastValue["y"], z: lastValue["z"]},
                    lastValue["r"] = values[1][0]
                    lastValue["p"] = values[1][1]
                    lastValue["ya"] = values[1][2]
                    lastValue["rpy"] = {x: lastValue["r"], y: lastValue["p"], z: lastValue["ya"]},
                    lastValue["buttonsValue"] = event.detail.buttons
                    lastValue["t"] = event.detail.time
                    v.refresh()
                });
                window.addEventListener("3dmousedisconnected", event => {
                    threeDMouse = null
                    connectButton.disabled = false
                    twistVizOverlays.forEach(overlay => overlay.stop())
                    f.disabled = true
                    v.disabled = true
                    g.disabled = true
                })

                threeDMouse = device
                connectButton.disabled = true
                f.disabled = false
                v.disabled = false
                g.disabled = false
            }).catch(error => {
                configurationParams["message"] = error
                pane.refresh()
            })
        );

    });

    function configureVideoView(container, ros, topic, targetPose, cameraPose) {
        let viewContainer = container.querySelector(".view")
        let overlayContainer = container.querySelector("canvas")
        subscribeToCameraTopic(ros, topic, viewContainer);
        let overlay = new TwistViz({container: container, canvas: overlayContainer, target_pose: targetPose, camera_pose: cameraPose})
        return overlay
    }

    function initializeRos(){
        return new Promise((resolve, reject) => {
            let ros = new ROSLIB.Ros({
                url: 'ws://127.0.0.1:9090'
            })

            ros.on('connection', () => {
                resolve(ros)
            })

            ros.on('error', (error) => {
                reject(error)
            })
        })
    }

</script>
</html>

